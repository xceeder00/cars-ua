{{ 'xc-choose.css' | asset_url | stylesheet_tag }}
{% assign slider_min = section.settings.step_2_form_min | default: 0 %}
{% assign slider_max = section.settings.step_2_form_max | default: 100000 %}
{% assign slider_default = slider_min %}
{% assign slider_min_money = slider_min | times: 100 %}
{% assign slider_max_money = slider_max | times: 100 %}
<div
  class="choose__container"
  data-choose-section="{{ section.id }}"
  data-current-step="1"
  data-locale="{{ request.locale.iso_code | default: shop.locale }}"
  data-currency="{{ cart.currency.iso_code | default: shop.currency }}"
  data-currency-symbol="{{ cart.currency.symbol | default: '$' | escape }}"
>
  <div class="choose__steps">
    <div class="choose__steps-header">
      <h2 class="choose__steps-title h3">{{ section.settings.title }}</h2>
      <div class="choose__steps-pagination">
        <span class="choose__steps-pagination-button is-active" data-step-btn="1" aria-label="Крок 1"></span>
        <span class="choose__steps-pagination-button" data-step-btn="2" aria-label="Крок 2"></span>
        <span class="choose__steps-pagination-button" data-step-btn="3" aria-label="Крок 3"></span>
      </div>
    </div>
    <hr>
   <div class="choose__form">      
      <input type="hidden" name="form_type" value="choose-step-form">
      <div class="choose__steps-body">
        <div class="choose__step is-active" data-step="1">
          <div class="choose__step-header">
            <h5 class="choose__step-title">{{ section.settings.step_1_title }}</h5>
            <p class="choose__step-description">{{ section.settings.step_1_description }}</p>
          </div>
          <div class="choose__step-list">
            {% for block in section.blocks %}
              <label class="choose__step-list-item" for="choose__type-{{ block.id }}">
                <input
                  type="radio"
                  name="contact[body_type]"
                  id="choose__type-{{ block.id }}"
                  value="{{ block.settings.title | escape }}"
                  {% if forloop.first %}checked{% endif %}
                >
                {% if block.settings.image != blank %}
                  <img
                    src="{{ block.settings.image | image_url: width: 800 }}"
                    alt="{{ block.settings.title | escape }}"
                    width="{{ block.settings.image.width }}"
                    height="{{ block.settings.image.height }}"
                    loading="lazy"
                  >
                {% endif %}
                <h6 class="choose__step-list-item-title">{{ block.settings.title }}</h6>
              </label>
            {% endfor %}
          </div>
        </div>
        <div class="choose__step" data-step="2">
          <div class="choose__step-header">
            <h5 class="choose__step-title">{{ section.settings.step_2_title }}</h5>
            <p class="choose__step-description">{{ section.settings.step_2_description }}</p>
          </div>
          <div class="choose__step-content">
            <div class="choose__form-card">
              <div class="choose__form-card-text">
                <p class="choose__form-card-title">{{ section.settings.step_2_form_title }}</p>
                <p class="choose__form-card-description">{{ section.settings.step_2_form_description }}</p>
              </div>
              <div class="choose__slider" data-choose-slider>
                
                <input
                  type="range"
                  class="choose__slider-input"
                  name="contact[budget]"
                  min="{{ slider_min }}"
                  max="{{ slider_max }}"
                  step="1000"
                  value="{{ slider_default }}"
                  aria-label="{{ section.settings.step_2_form_title }}"
                >
                <div class="choose__slider-labels">
                  <span class="choose__slider-label">{{ 'До ' }}{{ slider_min_money | money_without_trailing_zeros }}</span>
                   <output class="choose__slider-value">{{ slider_default }}</output>
                  <span class="choose__slider-label">{{ slider_max_money | money_without_trailing_zeros }}+</span>
                </div>
               
              </div>
            </div>
          </div>
          <div class="choose__step-footer">
            <button class="choose__step-footer-button circle-btn" type="button" data-step-btn="1" aria-label="Попередній крок">
              {% render 'icon', icon: 'chevron-left' %}
            </button>
            <button class="choose__step-footer-button btn btn--primary" type="button" data-step-btn="3" aria-label="Наступний крок">
              {{ section.settings.next_btn_label }}
            </button>
          </div>
        </div>
        <div class="choose__step" data-step="3">
          <div class="choose__step-header">
            <h5 class="choose__step-title">{{ section.settings.step_3_title }}</h5>
            <p class="choose__step-description">{{ section.settings.step_3_description }}</p>
          </div>
          <div class="choose__step-content">
            <div class="choose__form-card">
              <div class="choose__form-card-text">
                <p class="choose__form-card-title">
                  {{ section.settings.step_3_form_title }}
                </p>
              </div>
              <div class="choose__form-card-body">
                    <div id="AaHF3cFVQNTAzR0wvZ__forms_inline_XL4D6n" data-form-root="true" data-forms-id="forms-root-783686" data-forms-text-color="#202020" data-forms-button-background-color="#90F209" data-forms-button-label-color="#262626" data-forms-links-color="#1878b9" data-forms-errors-color="#e02229" data-forms-text-alignment="center" data-forms-alignment="center" data-forms-padding-top="0" data-forms-padding-right="0" data-forms-padding-bottom="0" data-forms-padding-left="0" style="--inline-container-min-height: 125px">
                    </div>
              </div>
            </div>
          </div>
          <div class="choose__step-footer">
            <button class="choose__step-footer-button circle-btn" type="button" data-step-btn="2" aria-label="Попередній крок">
              {% render 'icon', icon: 'chevron-left' %}
            </button>
            {% comment %} <button class="choose__step-footer-button btn btn--primary" type="submit">
              {{ section.settings.send_btn_label }}
            </button> {% endcomment %}
          </div>
        </div>
      </div>
     </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('[data-choose-section="{{ section.id }}"]');
    if (!section) return;

    const stepsBody = section.querySelector('.choose__steps-body');
    const steps = Array.from(section.querySelectorAll('.choose__step'));
    const paginationButtons = Array.from(section.querySelectorAll('.choose__steps-pagination-button'));
    const sliderWrapper = section.querySelector('[data-choose-slider]');
    const sliderInput = sliderWrapper && sliderWrapper.querySelector('.choose__slider-input');
    const sliderOutput = sliderWrapper && sliderWrapper.querySelector('.choose__slider-value');
    const typeInputs = section.querySelectorAll('input[name="contact[body_type]"]');
    const stateMarker = section.querySelector('[data-choose-initial-step]');
    const locale = section.dataset.locale || undefined;
    const currency = section.dataset.currency || undefined;
    let currentStep = parseInt(section.dataset.currentStep || '1', 10);
    if (stateMarker) {
      const markerStep = parseInt(stateMarker.getAttribute('data-choose-initial-step'), 10);
      if (!Number.isNaN(markerStep)) {
        currentStep = markerStep;
      }
      stateMarker.remove();
    }
    section.dataset.currentStep = String(currentStep);

    const currencySymbol = (section.dataset.currencySymbol || '').trim();
    const numberFormatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    
    // Store selected values for form
    let selectedBodyType = null;
    let selectedPrice = null;

    // Function to update form fields in Shadow DOM
    function updateFormFields() {
      // Try to find form container by data-forms-id
      const formContainer = document.querySelector('[data-forms-id="forms-root-783686"]');
      if (!formContainer) return false;
      
      // Try to find shopify-forms-embed inside container (might be created dynamically)
      let formEmbed = formContainer.querySelector('shopify-forms-embed');
      if (!formEmbed) {
        // Try to find by ID
        formEmbed = document.querySelector('#app-embed-choose');
      }
      if (!formEmbed) {
        // Try to find any shopify-forms-embed in the container
        formEmbed = formContainer.querySelector('shopify-forms-embed');
      }
      
      if (!formEmbed) return false;
      
      const shadowRoot = formEmbed.shadowRoot;
      if (!shadowRoot) return false;
      
      // Inject CSS styles for the form and hide field
      if (!shadowRoot.querySelector('style[data-choose-form-styling]')) {
        const formStyle = document.createElement('style');
        formStyle.setAttribute('data-choose-form-styling', 'true');
        formStyle.textContent = `
          
          [data-testid="field-custom#block"] {
            display: none !important;
          }
          label[for="label-custom#block"],
          label[id="label-custom#block"] {
            display: none !important;
          }
          ._formFieldContainer_1mxsl_5:has([data-testid="field-custom#block"]),
          ._formFieldContainer_1mxsl_5:has(input[id="custom#block"]) {
            display: none !important;
          }
          
          /* Hide fields "Тип Кузову" and "Ціна" */
          [data-testid="field-custom#type"],
          [data-testid="field-custom#price"] {
            display: none !important;
          }
          label[for="label-custom#type"],
          label[id="label-custom#type"],
          label[for="label-custom#price"],
          label[id="label-custom#price"] {
            display: none !important;
          }
          ._formFieldContainer_1mxsl_5:has([data-testid="field-custom#type"]),
          ._formFieldContainer_1mxsl_5:has(input[id="custom#type"]),
          ._formFieldContainer_1mxsl_5:has([data-testid="field-custom#price"]),
          ._formFieldContainer_1mxsl_5:has(input[id="custom#price"]) {
            display: none !important;
          }
          
          /* Input styling */
          ._formInputField_nag3b_7,
          ._formPhoneInputField_piv1u_17,
          input[type="text"],
          input[type="tel"],
          input[type="email"] {
            border: 1px solid rgba(0, 46, 9, 0.12) !important;
            border-radius: 8px !important;
            box-shadow: none !important;
            padding: 10px 16px !important;
            color: #000B02 !important;
            font-size: 16px !important;
            font-style: normal !important;
            font-weight: 400 !important;
            line-height: 160% !important;
            width: 100% !important;
            box-sizing: border-box !important;
          }
          
          /* Label styling */
          ._formFieldContainer_1mxsl_5 {
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
            margin-bottom: 24px !important;
            width: 100% !important;
          }
          
          ._formInputFieldLabel_1mxsl_38,
          label._formInputFieldLabel_1mxsl_38,
          label[id^="label-"],
          label[for^="label-"] {
            position: relative !important;
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            order: -1 !important;
            margin-bottom: 8px !important;
            color: rgba(0, 11, 2, 0.50) !important;
            font-size: 14px !important;
            font-style: normal !important;
            font-weight: 400 !important;
            line-height: 160% !important;
          }
          
          /* Remove inline styles from labels */
          label[style*="top"] {
            top: 0 !important;
          }
          
          /* Form container width */
          ._inline_1q1d2_47 ._formContainer_1q1d2_30 {
            max-width: 100% !important;
            width: 100% !important;
          }
          
          /* Phone input container */
          ._formPhoneInputContainer_piv1u_6 {
            display: flex !important;
            align-items: center !important;
            gap: 0 !important;
            width: 100% !important;
          }
          
          /* Phone input field container */
          ._formPhoneInputContainer_piv1u_6 ._formFieldContainer_1mxsl_5 {
            flex: 1 !important;
            width: 100% !important;
          }
          
          ._selectContainer_12thd_6,
          .phone-country-selector {
            display: none !important;
          }
          
          /* Form gap */
          form._formFieldset_cit2d_82 {
            gap: 0 !important;
          }
          
          /* Button styling */
          button._formSubmitButton_cit2d_96 {
            border-radius: 32px !important;
            color: #000B02 !important;
            font-size: 14px !important;
            font-style: normal !important;
            font-weight: 600 !important;
            line-height: 140% !important;
            letter-spacing: 0.28px !important;
          }

          /* Error messages styling */
          output[role="alert"],
          output[role="alert"] *,
          ._formError_1mxsl_21 {
            display: block !important;
            position: relative !important;
            top: auto !important;
            left: auto !important;
            right: auto !important;
            bottom: auto !important;
            transform: none !important;
            margin: 0 !important;
            margin-top: 4px !important;
            margin-bottom: -16px !important;
            padding: 0 !important;
            color: #e02229 !important;
            font-size: 12px !important;
            font-style: normal !important;
            font-weight: 400 !important;
            line-height: 140% !important;
            text-align: left !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            width: 100% !important;
            max-width: 100% !important;
            overflow: visible !important;
            visibility: visible !important;
            opacity: 1 !important;
          }

          /* Ensure error messages appear below fields, not beside them */
          ._formFieldContainer_1mxsl_5:has(output[role="alert"]),
          ._formPhoneInputContainer_piv1u_6:has(output[role="alert"]) {
            flex-direction: column !important;
            align-items: flex-start !important;
          }

          /* Error message that comes after field container (like first_name) */
          ._formFieldContainer_1mxsl_5 + output[role="alert"],
          ._formFieldContainer_1mxsl_5._withError_1mxsl_17 + output[role="alert"] {
            margin-top: 4px !important;
            margin-bottom: -16px !important;
            display: block !important;
            width: 100% !important;
          }

          /* Error message inside field container */
          ._formFieldContainer_1mxsl_5 output[role="alert"],
          ._formPhoneInputContainer_piv1u_6 output[role="alert"] {
            order: 999 !important;
            margin-top: 4px !important;
            margin-bottom: -16px !important;
          }

          /* Error message in form (general) */
          form._formFieldset_cit2d_82 output[role="alert"] {
            margin-top: 4px !important;
            margin-bottom: -16px !important;
          }
          
          /* Error message after phone container */
          ._formPhoneInputContainer_piv1u_6 + output[role="alert"] {
            margin-top: 4px !important;
            margin-bottom: -16px !important;
            display: block !important;
            width: 100% !important;
          }
        `;
        shadowRoot.appendChild(formStyle);
      }
      
      let updated = false;
      
      // Remove inline styles from labels
      const labels = shadowRoot.querySelectorAll('label._formInputFieldLabel_1mxsl_38');
      labels.forEach(function(label) {
        if (label.style.top) {
          label.style.top = '0';
        }
        if (label.style.position && label.style.position !== 'relative') {
          label.style.position = 'relative';
        }
        if (label.style.transform) {
          label.style.transform = 'none';
        }
      });
      
      // Find and hide "Секція звідки прийшла форма" field
      const fieldBlock = shadowRoot.querySelector('[data-testid="field-custom#block"]');
      if (fieldBlock) {
        // Set value first
        fieldBlock.value = 'Форма Підбору';
        fieldBlock.dispatchEvent(new Event('input', { bubbles: true }));
        fieldBlock.dispatchEvent(new Event('change', { bubbles: true }));
        
        // Then hide
        const container = fieldBlock.closest('._formFieldContainer_1mxsl_5');
        if (container) {
          container.style.display = 'none';
          container.style.visibility = 'hidden';
          container.style.height = '0';
          container.style.overflow = 'hidden';
          updated = true;
        }
      }
      
      // Find and hide "Тип Кузову" field
      const fieldType = shadowRoot.querySelector('[data-testid="field-custom#type"]');
      if (fieldType) {
        // Set value first
        if (selectedBodyType) {
          fieldType.value = selectedBodyType;
          fieldType.dispatchEvent(new Event('input', { bubbles: true }));
          fieldType.dispatchEvent(new Event('change', { bubbles: true }));
        }
        // Then hide
        const container = fieldType.closest('._formFieldContainer_1mxsl_5');
        if (container) {
          container.style.display = 'none';
          container.style.visibility = 'hidden';
          container.style.height = '0';
          container.style.overflow = 'hidden';
          updated = true;
        }
      }
      
      // Find and hide "Ціна" field
      const fieldPrice = shadowRoot.querySelector('[data-testid="field-custom#price"]');
      if (fieldPrice) {
        // Set value first
        if (selectedPrice !== null) {
          fieldPrice.value = selectedPrice;
          fieldPrice.dispatchEvent(new Event('input', { bubbles: true }));
          fieldPrice.dispatchEvent(new Event('change', { bubbles: true }));
        }
        // Then hide
        const container = fieldPrice.closest('._formFieldContainer_1mxsl_5');
        if (container) {
          container.style.display = 'none';
          container.style.visibility = 'hidden';
          container.style.height = '0';
          container.style.overflow = 'hidden';
          updated = true;
        }
      }
      
      // Find all containers and check by text content (fallback)
      const containers = shadowRoot.querySelectorAll('._formFieldContainer_1mxsl_5');
      for (let i = 0; i < containers.length; i++) {
        const container = containers[i];
        const text = container.textContent || '';
        const fieldInContainer = container.querySelector('input[type="text"]');
        
        // Hide "Секція звідки прийшла форма" field
        if (text.includes('Секція звідки прийшла форма')) {
          // Set value first
          if (fieldInContainer) {
            fieldInContainer.value = 'Форма Підбору';
            fieldInContainer.dispatchEvent(new Event('input', { bubbles: true }));
            fieldInContainer.dispatchEvent(new Event('change', { bubbles: true }));
          }
          container.style.display = 'none';
          container.style.visibility = 'hidden';
          container.style.height = '0';
          container.style.overflow = 'hidden';
          updated = true;
          continue;
        }
        
        // Hide "Тип Кузову" field
        if (text.includes('Тип Кузову')) {
          if (fieldInContainer && selectedBodyType) {
            fieldInContainer.value = selectedBodyType;
            fieldInContainer.dispatchEvent(new Event('input', { bubbles: true }));
            fieldInContainer.dispatchEvent(new Event('change', { bubbles: true }));
          }
          container.style.display = 'none';
          container.style.visibility = 'hidden';
          container.style.height = '0';
          container.style.overflow = 'hidden';
          updated = true;
          continue;
        }
        
        // Hide "Ціна" field
        if (text.includes('Ціна')) {
          if (fieldInContainer && selectedPrice !== null) {
            fieldInContainer.value = selectedPrice;
            fieldInContainer.dispatchEvent(new Event('input', { bubbles: true }));
            fieldInContainer.dispatchEvent(new Event('change', { bubbles: true }));
          }
          container.style.display = 'none';
          container.style.visibility = 'hidden';
          container.style.height = '0';
          container.style.overflow = 'hidden';
          updated = true;
          continue;
        }
      }
      
      // Move error messages inside their field containers
      const fieldContainers = shadowRoot.querySelectorAll('._formFieldContainer_1mxsl_5');
      fieldContainers.forEach(function(container) {
        // Find error message that comes right after this container
        const nextSibling = container.nextElementSibling;
        if (nextSibling && nextSibling.tagName === 'OUTPUT' && nextSibling.getAttribute('role') === 'alert') {
          // Move error inside container
          container.appendChild(nextSibling);
          // Ensure container has flex-direction column
          container.style.setProperty('display', 'flex', 'important');
          container.style.setProperty('flex-direction', 'column', 'important');
          updated = true;
        }
      });

      // Handle phone input container errors
      const phoneContainers = shadowRoot.querySelectorAll('._formPhoneInputContainer_piv1u_6');
      phoneContainers.forEach(function(container) {
        const nextSibling = container.nextElementSibling;
        if (nextSibling && nextSibling.tagName === 'OUTPUT' && nextSibling.getAttribute('role') === 'alert') {
          // For phone, we need to find the inner field container or create a wrapper
          const innerFieldContainer = container.querySelector('._formFieldContainer_1mxsl_5');
          if (innerFieldContainer) {
            innerFieldContainer.appendChild(nextSibling);
            innerFieldContainer.style.setProperty('display', 'flex', 'important');
            innerFieldContainer.style.setProperty('flex-direction', 'column', 'important');
            updated = true;
          } else {
            // If no inner container, append to phone container itself
            container.appendChild(nextSibling);
            container.style.setProperty('flex-direction', 'column', 'important');
            updated = true;
          }
        }
      });
      
      return updated;
    }

    const setActiveStep = (targetStep) => {
      if (targetStep < 1 || targetStep > steps.length) return;
      currentStep = targetStep;
      section.dataset.currentStep = String(currentStep);
      steps.forEach((stepEl) => {
        const stepIndex = parseInt(stepEl.dataset.step, 10);
        const isActive = stepIndex === currentStep;
        stepEl.classList.toggle('is-active', isActive);
        stepEl.setAttribute('aria-hidden', isActive ? 'false' : 'true');
      });
      paginationButtons.forEach((button) => {
        const stepIndex = parseInt(button.dataset.stepBtn, 10);
        button.classList.toggle('is-active', stepIndex === currentStep);
      });
      stepsBody.style.height = '';
      
      // Update form fields when step 3 is activated
      if (targetStep === 3) {
        const attempts = [100, 300, 500, 800, 1000, 1500, 2000, 3000, 4000, 5000];
        attempts.forEach(function(delay) {
          setTimeout(updateFormFields, delay);
        });
      }
    };

    const accentColor = (getComputedStyle(section).getPropertyValue('--choose-accent') || '').trim() || '#7ED321';
    const sliderTrackColor = (getComputedStyle(section).getPropertyValue('--choose-slider-track') || '').trim() || '#d9d9d9';

    const updateSliderValue = (value) => {
      if (!sliderOutput) return;
      const formattedNumber = numberFormatter.format(Number(value));
      sliderOutput.textContent = currencySymbol ? `${formattedNumber} ${currencySymbol}` : formattedNumber;
      // Update selectedPrice for form
      selectedPrice = currencySymbol ? `${formattedNumber} ${currencySymbol}` : formattedNumber;
      updateFormFields();
    };

    const updateSliderTrack = (value) => {
      if (!sliderInput) return;
      const min = Number(sliderInput.min || 0);
      const max = Number(sliderInput.max || 100);
      const numericValue = Number(value);
      const range = max - min;
      const percent = range === 0 ? 0 : ((numericValue - min) / range) * 100;
      sliderInput.style.background = `linear-gradient(90deg, ${accentColor} 0%, ${accentColor} ${percent}%, ${sliderTrackColor} ${percent}%, ${sliderTrackColor} 100%)`;
    };

    paginationButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const stepIndex = parseInt(button.dataset.stepBtn, 10);
        setActiveStep(stepIndex);
      });
    });

    section.addEventListener('click', (event) => {
      const trigger = event.target.closest('[data-step-btn]');
      if (!trigger) return;
      event.preventDefault();
      const targetStep = parseInt(trigger.dataset.stepBtn, 10);
      setActiveStep(targetStep);
    });

    // Get initial body type value and set up listeners
    typeInputs.forEach((input) => {
      if (input.checked) {
        selectedBodyType = input.value;
      }
      
      input.addEventListener('change', function() {
        selectedBodyType = this.value;
        setActiveStep(2);
        // Try to update form fields after change
        setTimeout(updateFormFields, 100);
        setTimeout(updateFormFields, 300);
        setTimeout(updateFormFields, 500);
      });
    });

    if (sliderInput) {
      // Set initial price value
      const formattedNumber = numberFormatter.format(Number(sliderInput.value));
      selectedPrice = currencySymbol ? `${formattedNumber} ${currencySymbol}` : formattedNumber;
      
      updateSliderValue(sliderInput.value);
      updateSliderTrack(sliderInput.value);
      sliderInput.addEventListener('input', (event) => {
        updateSliderValue(event.target.value);
        updateSliderTrack(event.target.value);
        // Try to update form fields after input
        setTimeout(updateFormFields, 100);
        setTimeout(updateFormFields, 300);
        setTimeout(updateFormFields, 500);
      });
      sliderInput.addEventListener('change', (event) => {
        updateSliderValue(event.target.value);
        updateSliderTrack(event.target.value);
        // Try to update form fields after change
        setTimeout(updateFormFields, 100);
        setTimeout(updateFormFields, 300);
        setTimeout(updateFormFields, 500);
      });
    }

    // Watch for form embed and update fields
    (function() {
      const attempts = [0, 100, 300, 500, 800, 1000, 1500, 2000, 3000, 4000, 5000];
      attempts.forEach(function(delay) {
        setTimeout(updateFormFields, delay);
      });
      
      // Watch for form container and shadow root
      const formContainer = document.querySelector('[data-forms-id="forms-root-783686"]');
      if (formContainer) {
        const containerObserver = new MutationObserver(function() {
          setTimeout(updateFormFields, 50);
          setTimeout(updateFormFields, 150);
          setTimeout(updateFormFields, 300);
        });
        
        containerObserver.observe(formContainer, { 
          childList: true, 
          subtree: true 
        });
        
        // Check for shopify-forms-embed periodically
        const checkFormEmbed = setInterval(function() {
          const formEmbed = formContainer.querySelector('shopify-forms-embed');
          if (formEmbed && formEmbed.shadowRoot) {
            const shadowObserver = new MutationObserver(function() {
              setTimeout(updateFormFields, 50);
              setTimeout(updateFormFields, 150);
              setTimeout(updateFormFields, 300);
            });
            
            shadowObserver.observe(formEmbed.shadowRoot, { 
              childList: true, 
              subtree: true 
            });
            
            // Try to update immediately after shadow root is found
            setTimeout(updateFormFields, 50);
            setTimeout(updateFormFields, 200);
            setTimeout(updateFormFields, 500);
            setTimeout(updateFormFields, 1000);
          }
        }, 100);
        
        setTimeout(function() {
          clearInterval(checkFormEmbed);
        }, 10000);
      }
    })();

    setActiveStep(currentStep);
  });
</script>
{% schema %}
{
    "name": "Choose",
    "tag": "section",
    "class": "choose section-padding",
    "settings": [
        {
            "type": "text",
            "id": "title",
            "label": "Title"
        },
        {
          "type": "text",
          "id": "next_btn_label",
          "label": "Next Button Label",
          "default": "Продовжити"
        },
        {
          "type": "text",
          "id": "send_btn_label",
          "label": "Send Button Label",
          "default": "Надіслати"
        },
        {
          "type": "header",
          "content": "Step 1"
        },
        {
          "type": "text",
          "id": "step_1_title",
          "label": "step 1 Title",
          "default": "Крок 1"
        },
        {
          "type": "text",
          "id": "step_1_description",
          "label": "Оберіть тип кузову"
        },
        {
            "type": "header",
            "content": "Step 2"
        },
        {
          "type": "text",
          "id": "step_2_title",
          "label": "step 2 Title",
          "default": "Крок 2"
        },
        {
          "type": "text",
          "id": "step_2_description",
          "label": "Бюджет"
        },
        {
          "type": "text",
          "id": "step_2_form_title",
          "label": "Form Title",
          "default": "Який ваш загальний бюджет?"
        },
        {
          "type": "text",
          "id": "step_2_form_description",
          "label": "Form Description",
          "default": "Сума, на яку ви розраховуєте при роботі “під ключ”."
        },
        {
          "type": "number",
          "id": "step_2_form_min",
          "label": "Min",
          "default": 8000
        },
        {
          "type": "number",
          "id": "step_2_form_max",
          "label": "Max",
          "default": 100000
        },
          
        {
            "type": "header",
            "content": "Step 3"
        },
        {
          "type": "text",
          "id": "step_3_title",
          "label": "step 3 Title",
          "default": "Крок 3"
        },
        {
          "type": "text",
          "id": "step_3_description",
          "label": "Заявка"
        },
        {
          "type": "text",
          "id": "step_3_form_title",
          "label": "Form Title",
          "default": "Ми зв’яжемось із Вами <br>з найкращими варіантами."
        }
    ],
    "blocks": [
        {
            "type": "step_1",
            "name": "Step 1",
            "settings": [
                {
                    "type": "text",
                    "id": "title",
                    "label": "Title"
                },
                {
                    "type": "image_picker",
                    "id": "image",
                    "label": "Image"
                }
            ]
        }
    ],
    "presets": [
        {
            "name": "Choose"
        }
    ]
}
{% endschema %}