
<dialog-component
    id="form-modal-common"
    class="search-modal "
    {{ section.shopify_attributes }}
    >
    <dialog
        ref="dialog"
        on:click="/closeDialogOnClickOutside"
        on:keydown="/closeDialogOnEscapePress"
        class="search-modal__content dialog-modal form-modal"
        scroll-lock
        aria-labelledby="search-modal-heading"
    >
    <div class="form-modal__wrapper">
       
        <div class="form-modal__product-top">
                {{ section.settings.title }}
                <button
                type="button"
                class="button predictive-search__close-modal-button"
                aria-label="{{ 'accessibility.close_dialog' | t }}"
                on:click="dialog-component/closeDialog"
                ref="closeModalButton"
            >
                <span class="svg-wrapper">
                {{ 'icon-close.svg' | inline_asset_content }}
                </span>
            </button>
        </div>
            
        <div class="form-modal__form">
            <div id="AaHF3cFVQNTAzR0wvZ__forms_inline_XL4D6n" data-form-root="true" data-forms-id="forms-root-782257" data-forms-text-color="#202020" data-forms-button-background-color="#90F209" data-forms-button-label-color="#262626" data-forms-links-color="#1878b9" data-forms-errors-color="#e02229" data-forms-text-alignment="center" data-forms-alignment="center" data-forms-padding-top="0" data-forms-padding-right="0" data-forms-padding-bottom="0" data-forms-padding-left="0" style="--inline-container-min-height: 125px">
                {% comment %} <shopify-forms-embed id="app-embed" style="display: block;"></shopify-forms-embed> {% endcomment %}
            </div>
            
            <script>
                // Store the data-label value when button is clicked
                let formSourceLabel = null;
                
                // Intercept button clicks to capture data-label
                document.addEventListener('click', function(e) {
                    // Find button that opens this dialog
                    const button = e.target.closest('button[on\\:click*="form-modal-common/showDialog"]');
                    if (button) {
                        // Get data-label if it exists
                        const label = button.getAttribute('data-label');
                        if (label) {
                            formSourceLabel = label;
                        } else {
                            // If no data-label, try to get from parent or use a default
                            formSourceLabel = null;
                        }
                    }
                }, true);
                
                // Set value to "Секція звідки прийшла форма" field and hide it
                (function() {
                    function setFieldValueAndHide() {
                        // Try to find form container by data-forms-id
                        const formContainer = document.querySelector('[data-forms-id="forms-root-782257"]');
                        if (!formContainer) return false;
                        
                        // Try to find shopify-forms-embed inside container (might be created dynamically)
                        let formEmbed = formContainer.querySelector('shopify-forms-embed');
                        if (!formEmbed) {
                            // Try to find by ID as fallback
                            formEmbed = document.querySelector('#app-embed');
                        }
                        if (!formEmbed) return false;
                        
                        const shadowRoot = formEmbed.shadowRoot;
                        if (!shadowRoot) return false;
                        
                        // First, inject CSS to hide the field and style the form
                        if (!shadowRoot.querySelector('style[data-hide-custom-field]')) {
                            const style = document.createElement('style');
                            style.setAttribute('data-hide-custom-field', 'true');
                            style.textContent = `
                                [data-testid="app-router"] {
                                    display: block !important;
                                }
                                /* Hide field by data-testid - most reliable */
                                [data-testid="field-custom#block"] {
                                    display: none !important;
                                }
                                /* Hide label */
                                label[for="label-custom#block"],
                                label[id="label-custom#block"] {
                                    display: none !important;
                                }
                                /* Hide container that contains our field */
                                ._formFieldContainer_1mxsl_5:has([data-testid="field-custom#block"]),
                                ._formFieldContainer_1mxsl_5:has(input[id="custom#block"]) {
                                    display: none !important;
                                }
                                
                                /* Hide VIN and Auto fields */
                                [data-testid="field-custom#vin"],
                                [data-testid="field-custom#auto"] {
                                    display: none !important;
                                }
                                
                                label[for="label-custom#vin"],
                                label[id="label-custom#vin"],
                                label[for="label-custom#auto"],
                                label[id="label-custom#auto"] {
                                    display: none !important;
                                }
                                
                                ._formFieldContainer_1mxsl_5:has([data-testid="field-custom#vin"]),
                                ._formFieldContainer_1mxsl_5:has(input[id="custom#vin"]),
                                ._formFieldContainer_1mxsl_5:has([data-testid="field-custom#auto"]),
                                ._formFieldContainer_1mxsl_5:has(input[id="custom#auto"]) {
                                    display: none !important;
                                }
                                
                                /* Input styling */
                                ._formInputField_nag3b_7,
                                ._formPhoneInputField_piv1u_17,
                                input[type="text"],
                                input[type="tel"],
                                input[type="email"] {
                                    border: 1px solid rgba(0, 46, 9, 0.12) !important;
                                    border-radius: 8px !important;
                                    box-shadow: none !important;
                                    padding: 10px 16px !important;
                                    color: #000B02 !important;
                                    font-size: 16px !important;
                                    font-style: normal !important;
                                    font-weight: 400 !important;
                                    line-height: 160% !important; /* 25.6px */
                                }
                                
                                /* Label styling: Make it relative and position before input */
                                ._formFieldContainer_1mxsl_5 {
                                    position: relative !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                    margin-bottom: 24px !important;
                                    width: 100% !important;
                                }
                                
                                ._formInputFieldLabel_1mxsl_38,
                                label._formInputFieldLabel_1mxsl_38 {
                                    position: relative !important;
                                    top: 0 !important;
                                    left: 0 !important;
                                    transform: none !important;
                                    order: -1 !important;
                                    margin-bottom: 8px !important;
                                    color: rgba(0, 11, 2, 0.50) !important;
                                    font-size: 14px !important;
                                    font-style: normal !important;
                                    font-weight: 400 !important;
                                    line-height: 160% !important; /* 22.4px */
                                }
                            `;
                            shadowRoot.appendChild(style);
                        }
                        
                        // Also inject form styling CSS separately to ensure it applies
                        if (!shadowRoot.querySelector('style[data-form-styling]')) {
                            const formStyle = document.createElement('style');
                            formStyle.setAttribute('data-form-styling', 'true');
                            formStyle.textContent = `

                                /* Input styling */
                                [data-testid="app-router"] {
                                    display: block !important;
                                }
                                input._formInputField_nag3b_7,
                                input._formPhoneInputField_piv1u_17,
                                input[type="text"],
                                input[type="tel"] {
                                    border: 1px solid rgba(0, 46, 9, 0.12) !important;
                                    border-radius: 8px !important;
                                    box-shadow: none !important;
                                    padding: 10px 16px !important;
                                    color: #000B02 !important;
                                    font-size: 16px !important;
                                    font-style: normal !important;
                                    font-weight: 400 !important;
                                    line-height: 160% !important; /* 25.6px */
                                }
                                
                                /* Make labels relative and position them before inputs */
                                ._formFieldContainer_1mxsl_5 {
                                    display: flex !important;
                                    flex-direction: column !important;
                                    margin-bottom: 24px !important;
                                    width: 100% !important;
                                }
                                
                                ._formFieldContainer_1mxsl_5 label {
                                    position: relative !important;
                                    top: 0 !important;
                                    left: 0 !important;
                                    transform: none !important;
                                    order: -1 !important;
                                    margin-bottom: 8px !important;
                                    color: rgba(0, 11, 2, 0.50) !important;
                                    font-size: 14px !important;
                                    font-style: normal !important;
                                    font-weight: 400 !important;
                                    line-height: 160% !important; /* 22.4px */
                                }
                                
                                /* Form gap */
                                form._formFieldset_cit2d_82 {
                                    gap: 0 !important;
                                }
                                
                                /* Form container max-width */
                                ._inline_1q1d2_47 ._formContainer_1q1d2_30 {
                                    max-width: 100% !important;
                                }
                                
                                /* Phone input container alignment */
                                ._formPhoneInputContainer_piv1u_6 {
                                    display: flex !important;
                                    align-items: center !important;
                                    gap: 0 !important;
                                    
                                }
                                
                                ._formPhoneInputContainer_piv1u_6 .phone-country-selector {
                                    display: flex !important;
                                    align-items: center !important;
                                }
                                
                                ._formPhoneInputContainer_piv1u_6 ._formFieldContainer_1mxsl_5 {
                                    flex: 1 !important;
                                    margin-bottom: 24px !important;
                                }
                                
                                /* Remove box-shadow from all form elements */
                                ._formFieldContainer_1mxsl_5,
                                ._formPhoneInputContainer_piv1u_6,
                                .phone-country-selector,
                                button._selectToggle_12thd_25 {
                                    box-shadow: none !important;
                                }
                                
                                /* Hide country selector container */
                                ._selectContainer_12thd_6,
                                .phone-country-selector {
                                    display: none !important;
                                }
                                
                                /* Button styling */
                                button._formSubmitButton_cit2d_96,
                                button[type="submit"],
                                button[data-testid="btn-form-submit"] {
                                    border-radius: 32px !important;
                                    color: #000B02 !important;
                                    font-size: 14px !important;
                                    font-style: normal !important;
                                    font-weight: 600 !important;
                                    line-height: 140% !important; /* 19.6px */
                                    letter-spacing: 0.28px !important;
                                }
                            `;
                            shadowRoot.appendChild(formStyle);
                        }
                        
                        let foundAny = false;
                        
                        // Find and hide custom#block field
                        const field = shadowRoot.querySelector('[data-testid="field-custom#block"]');
                        if (field) {
                            // Set value if we have formSourceLabel
                            if (formSourceLabel) {
                                field.value = formSourceLabel;
                                field.dispatchEvent(new Event('input', { bubbles: true }));
                                field.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                            
                            // Find and hide container
                            const container = field.closest('._formFieldContainer_1mxsl_5');
                            if (container) {
                                container.style.display = 'none';
                                container.style.visibility = 'hidden';
                                container.style.height = '0';
                                container.style.overflow = 'hidden';
                                foundAny = true;
                            }
                        }
                        
                        // Find and hide custom#vin field (VIN)
                        const fieldVin = shadowRoot.querySelector('[data-testid="field-custom#vin"]');
                        if (fieldVin) {
                            const container = fieldVin.closest('._formFieldContainer_1mxsl_5');
                            if (container) {
                                container.style.display = 'none';
                                container.style.visibility = 'hidden';
                                container.style.height = '0';
                                container.style.overflow = 'hidden';
                                foundAny = true;
                            }
                        }
                        
                        // Find and hide custom#auto field (Авто)
                        const fieldAuto = shadowRoot.querySelector('[data-testid="field-custom#auto"]');
                        if (fieldAuto) {
                            const container = fieldAuto.closest('._formFieldContainer_1mxsl_5');
                            if (container) {
                                container.style.display = 'none';
                                container.style.visibility = 'hidden';
                                container.style.height = '0';
                                container.style.overflow = 'hidden';
                                foundAny = true;
                            }
                        }
                        
                        // Always check for VIN and Авто fields by text content
                        const allContainers = shadowRoot.querySelectorAll('._formFieldContainer_1mxsl_5');
                        for (let i = 0; i < allContainers.length; i++) {
                            const container = allContainers[i];
                            const text = container.textContent || '';
                            
                            if (text.includes('VIN') && !text.includes('Секція')) {
                                container.style.display = 'none';
                                container.style.visibility = 'hidden';
                                container.style.height = '0';
                                container.style.overflow = 'hidden';
                                foundAny = true;
                            }
                            if (text.includes('Авто') && !text.includes('Секція')) {
                                container.style.display = 'none';
                                container.style.visibility = 'hidden';
                                container.style.height = '0';
                                container.style.overflow = 'hidden';
                                foundAny = true;
                            }
                        }
                        
                        // Fallback: Find all containers and check by text content (only for custom#block)
                        if (!foundAny) {
                            const containers = shadowRoot.querySelectorAll('._formFieldContainer_1mxsl_5');
                            for (let i = 0; i < containers.length; i++) {
                                const container = containers[i];
                                const text = container.textContent || '';
                                
                                if (text.includes('Секція звідки прийшла форма')) {
                                    const fieldInContainer = container.querySelector('input[type="text"]');
                                    if (fieldInContainer) {
                                        // Set value
                                        if (formSourceLabel) {
                                            fieldInContainer.value = formSourceLabel;
                                            fieldInContainer.dispatchEvent(new Event('input', { bubbles: true }));
                                            fieldInContainer.dispatchEvent(new Event('change', { bubbles: true }));
                                        }
                                        
                                        // Hide container
                                        container.style.display = 'none';
                                        container.style.visibility = 'hidden';
                                        container.style.height = '0';
                                        container.style.overflow = 'hidden';
                                        foundAny = true;
                                    }
                                }
                            }
                        }
                        
                        return foundAny;
                    }
                    
                    // Try immediately and multiple times
                    const attempts = [0, 100, 300, 500, 800, 1000, 1500, 2000, 3000];
                    attempts.forEach(function(delay) {
                        setTimeout(setFieldValueAndHide, delay);
                    });
                    
                    // Watch for dialog open
                    const dialog = document.querySelector('#form-modal-common dialog');
                    if (dialog) {
                        const observer = new MutationObserver(function() {
                            if (dialog.hasAttribute('open')) {
                                // Try to set value and hide when dialog opens
                                setTimeout(setFieldValueAndHide, 100);
                                setTimeout(setFieldValueAndHide, 300);
                                setTimeout(setFieldValueAndHide, 600);
                                setTimeout(setFieldValueAndHide, 1000);
                                setTimeout(setFieldValueAndHide, 1500);
                            } else {
                                // Clear the label when dialog closes
                                formSourceLabel = null;
                            }
                        });
                        observer.observe(dialog, { attributes: true, attributeFilter: ['open'] });
                    }
                    
                    // Watch for shadow root content changes
                    const formContainer = document.querySelector('[data-forms-id="forms-root-782257"]');
                    if (formContainer) {
                        const containerObserver = new MutationObserver(function() {
                            setTimeout(setFieldValueAndHide, 50);
                        });
                        
                        containerObserver.observe(formContainer, { 
                            childList: true, 
                            subtree: true 
                        });
                        
                        // Check for shopify-forms-embed periodically
                        const checkFormEmbed = setInterval(function() {
                            const formEmbed = formContainer.querySelector('shopify-forms-embed');
                            if (formEmbed && formEmbed.shadowRoot) {
                                const shadowObserver = new MutationObserver(function() {
                                    setTimeout(setFieldValueAndHide, 50);
                                });
                                
                                shadowObserver.observe(formEmbed.shadowRoot, { 
                                    childList: true, 
                                    subtree: true 
                                });
                                
                                // Try to update immediately after shadow root is found
                                setTimeout(setFieldValueAndHide, 50);
                                setTimeout(setFieldValueAndHide, 200);
                                setTimeout(setFieldValueAndHide, 500);
                                clearInterval(checkFormEmbed);
                            }
                        }, 100);
                        
                        setTimeout(function() {
                            clearInterval(checkFormEmbed);
                        }, 10000);
                    }
                })();
            </script>
        </div>
        <a href="tel:{{ section.settings.phone_number }}" title="Подзвонити" class="form-modal__phone">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.6927 10.388C10.3836 10.6971 9.90969 10.7696 9.52236 10.5672C8.65669 10.1148 7.86092 9.53184 7.16445 8.83537C6.46796 8.13888 5.88505 7.34309 5.43264 6.47744C5.23021 6.0901 5.30276 5.61618 5.61179 5.30714L6.50406 4.41488L5.97348 3H3.33315C3.23704 3 3.16109 3.03891 3.11591 3.08567C3.0754 3.1276 3.0621 3.17 3.06765 3.21972C3.1821 4.24552 3.44059 5.25217 3.83714 6.20952C4.38994 7.5441 5.2002 8.75673 6.22164 9.77818C7.24309 10.7996 8.45571 11.6099 9.79028 12.1627C10.7476 12.5592 11.7543 12.8177 12.7801 12.9322C12.8298 12.9377 12.8722 12.9244 12.9141 12.8839C12.9609 12.8387 12.9998 12.7628 12.9998 12.6667V10.0264L11.5849 9.49578L10.6927 10.388ZM9.98555 9.68094L10.9537 8.71278C11.1848 8.48171 11.5296 8.40702 11.8356 8.52177L13.4591 9.13058C13.7843 9.25255 13.9998 9.56349 13.9998 9.91086V12.6667C13.9998 13.4031 13.401 14.0077 12.6692 13.926C11.5501 13.8012 10.452 13.5192 9.40759 13.0866C7.95169 12.4835 6.62884 11.5996 5.51453 10.4853C4.40023 9.37098 3.51632 8.04811 2.91326 6.5922C2.48067 5.54782 2.19867 4.44966 2.07381 3.3306C1.99216 2.59876 2.59677 2 3.33315 2H6.08898C6.43635 2 6.74729 2.21548 6.86926 2.54073L7.47807 4.16424C7.59281 4.47022 7.51813 4.81502 7.28705 5.0461L6.3189 6.01425C6.72453 6.79038 7.24713 7.50384 7.87155 8.12826C8.49598 8.75268 9.20942 9.27531 9.98555 9.68094Z" fill="#000B02"/>
                </svg>
            <span>{{ section.settings.phone_label }}</span>
        </a>
        </div>
    </dialog>
</dialog-component>

{% schema %}
    {
        "name": "XC Dialog",
        "settings": [
            {
                "type": "text",
                "id": "phone_label",
                "label": "Phone Label",
                "default": "Зателефонувати зараз"
            },
            {
                "type": "text",
                "id": "title",
                "label": "Title",
                "default": "Замовити дзвінок"
            },
            {
                "type": "text",
                "id": "phone_number",
                "label": "Phone Number",
                "default": "+380671234567"
            }
    ],
    "presets": [
        {
            "name": "XC Dialog",
            "settings": {
                "phone_label": "Зателефонувати зараз",
                "title": "Замовити дзвінок",
                "phone_number": "+380671234567"
            }
        }
    ]
  }
{% endschema %}
